<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <title>Painel Admin - ENENG</title>
        <link rel="stylesheet" href="css/registro.css" />
        <link rel="stylesheet" href="css/header-nav.css" />
        <link rel="stylesheet" href="css/footer.css" />
        <script src="https://unpkg.com/lucide@latest"></script>
        <style>
            body {
                background-color: #f0f0f0;
            }
            .form-container {
                max-width: 1000px;
                padding: 20px;
                margin: 0 auto;
                margin-top: 20px;
            }
            .card-menu {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .card {
                background-color: blue;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                text-align: center;
                cursor: pointer;
                transition: transform 0.2s;
                font-weight: bold;
                color: white;
            }
            .card:hover {
                transform: translateY(-5px);
                background-color: #f5a002;
                color: blue;
            }
            .card i {
                color: #f5a002 !important;
            }
            .card h3 {
                margin-top: 10px;
                font-size: 18px;
            }
            .section {
                display: none;
                margin-top: 30px;
                background: white;
                padding: 20px;
                border-radius: 10px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            th,
            td {
                padding: 8px;
                border: 1px solid #ccc;
            }
            th {
                background-color: #f5a002;
                color: white;
            }
            input {
                padding: 10px;
                margin-top: 10px;
                font-size: 16px;
                width: 100%;
            }
            button {
                padding: 10px;
                margin-top: 10px;
                font-size: 16px;
                background-color: blue;
                color: #f5a002;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-transform: uppercase;
                font-weight: bold;
                display: inline-block;
                min-width: fit-content;
            }
            button:hover {
                background-color: #f5a002;
                color: blue;
            }
        </style>
    </head>
    <body>
        <div id="header-nav-container"></div>
        <div class="form-container">
            <h2 style="text-align: center">Painel Administrativo</h2>

            <div class="card-menu">
                <div class="card" onclick="showSection('dashboard')">
                    <i data-lucide="bar-chart"></i>
                    <h3>Dashboard</h3>
                </div>
                <div class="card" onclick="showSection('usuarios')">
                    <i data-lucide="users"></i>
                    <h3>Usuários</h3>
                </div>
                <div class="card" onclick="showSection('promover')">
                    <i data-lucide="arrow-up-circle"></i>
                    <h3>Promover Admin</h3>
                </div>
                <div class="card" onclick="showSection('remover')">
                    <i data-lucide="arrow-down-circle"></i>
                    <h3>Remover Admin</h3>
                </div>
            </div>

            <div id="dashboard" class="section">
                <h3>📊 Estatísticas do Sistema</h3>
                <p>
                    <strong>Total de Usuários:</strong>
                    <span id="totalUsers">...</span>
                </p>
                <p>
                    <strong>Total de Admins:</strong>
                    <span id="totalAdmins">...</span>
                </p>
            </div>

            <div id="usuarios" class="section">
                <h3>👥 Lista de Usuários</h3>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Buscar por nome, e-mail ou WhatsApp"
                />
                <div id="userTableContainer"></div>
                <div style="text-align: center; margin-top: 10px">
                    <button id="prevPageBtn">Anterior</button>
                    <span id="pageIndicator">Página 1</span>
                    <button id="nextPageBtn">Próxima</button>
                    <button onclick="exportToCSV()">Exportar CSV</button>
                </div>
            </div>

            <div id="promover" class="section">
                <h3>⬆️ Promover Usuário a Admin</h3>
                <input
                    type="text"
                    id="promoteUid"
                    placeholder="UID do usuário"
                />
                <button onclick="promoteToAdmin()">Promover</button>
            </div>

            <div id="remover" class="section">
                <h3>⬇️ Remover Admin</h3>
                <input type="text" id="removeUid" placeholder="UID do admin" />
                <button onclick="removeAdmin()">Remover</button>
            </div>

            <div style="text-align: center; margin-top: 30px">
                <button onclick="logout()">Sair</button>
            </div>
        </div>
        <div id="footer-container"></div>

        <script type="module">
            import {
                getApps,
                initializeApp,
            } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
            import {
                getAuth,
                onAuthStateChanged,
                signOut,
            } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
            import {
                getFirestore,
                doc,
                getDoc,
                getDocs,
                setDoc,
                deleteDoc,
                collection,
            } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

            const firebaseConfig = {
                apiKey: 'AIzaSyCYfIlHU7ZT-Cs8VHxugTaSSFXjfSDiaPg',
                authDomain: 'eneng-b34ee.firebaseapp.com',
                projectId: 'eneng-b34ee',
                storageBucket: 'eneng-b34ee.firebasestorage.app',
                messagingSenderId: '401693608382',
                appId: '1:401693608382:web:a912bbb51dac61d88151ef',
                measurementId: 'G-LSC3PG9XKM',
            };

            // Função principal
            async function main() {
                // 1) carrega header + footer + footer-status.js
                const header = await fetch('header-nav.html').then((r) =>
                    r.text()
                );
                document.getElementById('header-nav-container').innerHTML =
                    header;
                const footer = await fetch('footer.html').then((r) => r.text());
                document.getElementById('footer-container').innerHTML = footer;
                lucide.createIcons();

                // injeta footer-status.js e aguarda carga
                await new Promise((resolve) => {
                    const s = document.createElement('script');
                    s.type = 'module';
                    s.src = 'js/footer-status.js';
                    s.onload = s.onerror = resolve;
                    document.body.appendChild(s);
                });

                // 2) inicializa seu app só se não existir instância
                if (!getApps().length) {
                    initializeApp(firebaseConfig);
                }
                const auth = getAuth();
                const db = getFirestore();

                // rotinas de logout e navegação de seções
                window.logout = () =>
                    signOut(auth).then(() => (location.href = 'login.html'));
                window.showSection = (id) => {
                    document
                        .querySelectorAll('.section')
                        .forEach((el) => (el.style.display = 'none'));
                    document.getElementById(id).style.display = 'block';
                };

                // estatísticas
                async function loadDashboard() {
                    const usersSnap = await getDocs(collection(db, 'users'));
                    const adminsSnap = await getDocs(collection(db, 'admins'));
                    document.getElementById('totalUsers').innerText =
                        usersSnap.size;
                    document.getElementById('totalAdmins').innerText =
                        adminsSnap.size;
                }

                // listagem paginada
                let currentPage = 1,
                    itemsPerPage = 10;
                let allUsers = [],
                    filteredUsers = [];

                async function loadUsers() {
                    const snap = await getDocs(collection(db, 'users'));
                    allUsers = snap.docs.map((d) => ({
                        uid: d.id,
                        ...d.data(),
                    }));
                    filteredUsers = [...allUsers];
                    renderTable();
                }

                function renderTable() {
                    const start = (currentPage - 1) * itemsPerPage;
                    const page = filteredUsers.slice(
                        start,
                        start + itemsPerPage
                    );
                    const rows = page
                        .map(
                            (u) => `
          <tr>
            <td>${u.nome || '-'}</td>
            <td>${u.email || '-'}</td>
            <td>${u.whatsapp || '-'}</td>
            <td>${u.uid}</td>
          </tr>`
                        )
                        .join('');
                    document.getElementById('userTableContainer').innerHTML = `
          <table>
            <tr><th>Nome</th><th>Email</th><th>WhatsApp</th><th>UID</th></tr>
            ${rows || '<tr><td colspan="4">Nenhum usuário encontrado</td></tr>'}
          </table>`;
                    document.getElementById(
                        'pageIndicator'
                    ).innerText = `Página ${currentPage}`;
                }

                // eventos de busca e paginação
                document
                    .getElementById('searchInput')
                    .addEventListener('input', () => {
                        const q = document
                            .getElementById('searchInput')
                            .value.toLowerCase();
                        filteredUsers = allUsers.filter(
                            (u) =>
                                (u.nome || '').toLowerCase().includes(q) ||
                                (u.email || '').toLowerCase().includes(q) ||
                                (u.whatsapp || '').toLowerCase().includes(q)
                        );
                        currentPage = 1;
                        renderTable();
                    });
                document
                    .getElementById('prevPageBtn')
                    .addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            renderTable();
                        }
                    });
                document
                    .getElementById('nextPageBtn')
                    .addEventListener('click', () => {
                        if (currentPage * itemsPerPage < filteredUsers.length) {
                            currentPage++;
                            renderTable();
                        }
                    });

                // promoção e remoção de admin
                window.promoteToAdmin = async () => {
                    const uid = document
                        .getElementById('promoteUid')
                        .value.trim();
                    if (!uid) return alert('UID inválido');
                    const u = await getDoc(doc(db, 'users', uid));
                    if (!u.exists()) return alert('Usuário não encontrado');
                    await setDoc(doc(db, 'admins', uid), u.data());
                    alert('Promovido a admin!');
                    loadDashboard();
                };
                window.removeAdmin = async () => {
                    const uid = document
                        .getElementById('removeUid')
                        .value.trim();
                    if (!uid) return alert('UID inválido');
                    await deleteDoc(doc(db, 'admins', uid));
                    alert('Admin removido!');
                    loadDashboard();
                };

                // export CSV
                window.exportToCSV = () => {
                    const csv = [
                        ['Nome', 'Email', 'WhatsApp', 'UID'],
                        ...filteredUsers.map((u) => [
                            u.nome || '-',
                            u.email || '-',
                            u.whatsapp || '-',
                            u.uid,
                        ]),
                    ]
                        .map((r) => r.join(','))
                        .join('\n');
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'usuarios.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };

                // autenticação e início
                onAuthStateChanged(auth, async (user) => {
                    if (!user) return (location.href = 'login.html');
                    const adm = await getDoc(doc(db, 'admins', user.uid));
                    if (!adm.exists()) {
                        alert('Acesso restrito');
                        return (location.href = 'login.html');
                    }
                    await loadDashboard();
                    await loadUsers();
                });
            }

            // garante que o DOM inteiro esteja pronto
            document.addEventListener('DOMContentLoaded', () => {
                // inicializa ícones
                lucide.createIcons();
                // e dispara nossa lógica
                main().catch((err) => console.error(err));
            });
        </script>

        <!-- coloque imediatamente antes de </body> -->
        <script
            src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"
            onload="lucide.createIcons({ stroke:'#f5a002', strokeWidth:2, size:24 });"
        ></script>
    </body>
</html>
